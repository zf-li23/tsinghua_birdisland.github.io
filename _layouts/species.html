<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page.title }} | 鸟岛与少年</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Roboto:wght@300;400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">
    <link rel="stylesheet" href="{{ '/assets/css/species.css' | relative_url }}">
</head>

<body>
    <div class="page-wrapper">
        <!-- 顶部导航栏 -->
        {% include header.html %}

        <div class="main-container species-container">
            <!-- 左侧分类导航 -->
            <aside class="species-sidebar" id="speciesSidebar">
                <div class="sidebar-header">
                    <h2>物种分类</h2>
                    <button id="speciesSearchToggle" class="search-toggle" title="搜索物种">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <!-- 搜索框 -->
                <div class="search-container" id="speciesSearchContainer">
                    <input type="text" id="speciesSearch" placeholder="搜索物种名称或学名...">
                    <button id="clearSearch" class="clear-search">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- 分类树状导航 -->
                <div class="taxonomy-tree" id="taxonomyTree">
                    <!-- 分类树将由JavaScript动态生成 -->
                </div>
            </aside>

            <!-- 右侧内容区域 -->
            <main class="species-content">
                <div class="species-header">
                    <h1>{{ page.title }}</h1>
                    <div class="view-controls">
                        <button id="gridViewBtn" class="view-btn active" title="网格视图">
                            <i class="fas fa-th"></i>
                        </button>
                        <button id="listViewBtn" class="view-btn" title="列表视图">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 筛选控制 -->
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="conservationFilter">保护等级:</label>
                        <select id="conservationFilter">
                            <option value="all">全部</option>
                            <option value="CR">极危 (CR)</option>
                            <option value="EN">濒危 (EN)</option>
                            <option value="VU">易危 (VU)</option>
                            <option value="NT">近危 (NT)</option>
                            <option value="LC">无危 (LC)</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="sortBy">排序:</label>
                        <select id="sortBy">
                            <option value="name">按名称</option>
                            <option value="scientific">按学名</option>
                            <option value="conservation">按保护等级</option>
                        </select>
                        <button id="resetFilters" class="reset-btn">恢复默认排序</button>
                    </div>
                </div>
                
                <!-- 物种展示区域 -->
                <div class="species-grid" id="speciesGrid">
                    <!-- 物种卡片将由JavaScript动态生成 -->
                </div>
                
                <!-- 物种详情模态框 -->
                <div class="species-modal" id="speciesModal">
                    <div class="modal-content">
                        <button class="modal-close" id="modalClose">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="modal-body" id="modalBody">
                            <!-- 物种详情内容将动态填充 -->
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- 页脚区域 -->
        {% include footer.html %}

        <!-- 侧边栏控制按钮 -->
        <div class="sidebar-toggle" id="sidebarToggle" title="显示/隐藏分类">
            <i class="fas fa-bars"></i>
        </div>
    </div>

    <!-- 内联JavaScript -->
    <script>
        // 物种数据（将从Jekyll数据文件加载）
        const speciesData = {
            birds: {% if site.data.species.birds %}{{ site.data.species.birds | jsonify }}{% else %}[]{% endif %},
            plants: {% if site.data.species.plants %}{{ site.data.species.plants | jsonify }}{% else %}[]{% endif %},
            insects: {% if site.data.species.insects %}{{ site.data.species.insects | jsonify }}{% else %}[]{% endif %}
        };
        
        // 当前页面类型（鸟类、植物或昆虫）
        const currentPageType = '{{ page.type }}'; // 需要在Front Matter中设置type
        
        // DOM元素
        const taxonomyTree = document.getElementById('taxonomyTree');
        const speciesGrid = document.getElementById('speciesGrid');
        const speciesSearch = document.getElementById('speciesSearch');
        const speciesModal = document.getElementById('speciesModal');
        const modalBody = document.getElementById('modalBody');
        const modalClose = document.getElementById('modalClose');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const speciesSidebar = document.getElementById('speciesSidebar');
        const searchToggle = document.getElementById('speciesSearchToggle');
        const searchContainer = document.getElementById('speciesSearchContainer');
        const clearSearch = document.getElementById('clearSearch');
        const gridViewBtn = document.getElementById('gridViewBtn');
        const listViewBtn = document.getElementById('listViewBtn');
        const conservationFilter = document.getElementById('conservationFilter');
        const sortBy = document.getElementById('sortBy');
        
        // 状态变量
        let currentView = 'grid';
        let currentFilters = {
            conservation: 'all',
            sort: 'name',
            search: '',
            taxonomy: null
        };
        
        // 初始化函数
        function initSpeciesPage() {
            // 生成分类树
            generateTaxonomyTree();
            
            // 生成物种网格
            renderSpeciesGrid();
            
            // 添加事件监听器
            addEventListeners();
        }
        
        // 生成分类树
        function generateTaxonomyTree() {
            const data = speciesData[currentPageType];
            if (!data || data.length === 0) {
                taxonomyTree.innerHTML = '<div class="no-data">暂无分类数据</div>';
                return;
            }
            
            let html = '<ul class="taxonomy-list">';
            
            data.forEach(order => {
                html += `
                <li class="taxonomy-item">
                    <div class="taxonomy-node" data-type="order" data-id="${order.order}">
                        <span class="toggle-icon"><i class="fas fa-caret-right"></i></span>
                        <span class="taxonomy-name">${order.order}</span>
                    </div>
                    <ul class="taxonomy-sublist">`;
                
                order.families.forEach(family => {
                    html += `
                    <li class="taxonomy-item">
                        <div class="taxonomy-node" data-type="family" data-id="${family.family}">
                            <span class="toggle-icon"><i class="fas fa-caret-right"></i></span>
                            <span class="taxonomy-name">${family.family}</span>
                        </div>
                        <ul class="taxonomy-sublist">`;
                    
                    family.genera.forEach(genus => {
                        html += `
                        <li class="taxonomy-item">
                            <div class="taxonomy-node" data-type="genus" data-id="${genus.genus}">
                                <span class="toggle-icon"><i class="fas fa-caret-right"></i></span>
                                <span class="taxonomy-name">${genus.genus}</span>
                            </div>
                            <ul class="taxonomy-sublist">`;
                        
                        genus.species.forEach(species => {
                            html += `
                            <li class="taxonomy-item">
                                <div class="taxonomy-node species-node" data-type="species" data-id="${species.name}">
                                    <span class="taxonomy-name">${species.name}</span>
                                    <span class="scientific-name">${species.scientific_name}</span>
                                </div>
                            </li>`;
                        });
                        
                        html += `</ul></li>`;
                    });
                    
                    html += `</ul></li>`;
                });
                
                html += `</ul></li>`;
            });
            
            html += '</ul>';
            taxonomyTree.innerHTML = html;
        }
        
        // 渲染物种网格
        function renderSpeciesGrid() {
            // 获取过滤后的物种数据
            const filteredSpecies = filterSpecies();
            
            if (filteredSpecies.length === 0) {
                speciesGrid.innerHTML = '<div class="no-results">没有找到匹配的物种</div>';
                return;
            }
            
            let html = '';
            
            filteredSpecies.forEach(species => {
                const statusClass = getConservationStatusClass(species.conservation_status);
                
                html += `
                <div class="species-card" data-species="${species.name}">
                    <div class="card-image">
                        {% capture img_src %}/assets/images/species/{{ currentPageType }}/{{ species.image }}{% endcapture %}
                        <img src="{{ img_src | relative_url }}"
                             alt="{{ species.name | default: 'species' }}"
                             onerror="this.src='{{ '/assets/images/placeholder.jpg' | relative_url }}'">
                        <div class="conservation-badge ${statusClass}">${species.conservation_status || '未知'}</div>
                    </div>
                    <div class="card-content">
                        <h3 class="species-name">${species.name}</h3>
                        <p class="scientific-name">${species.scientific_name}</p>
                        <p class="species-desc">${truncateText(species.description, 100)}</p>
                    </div>
                </div>`;
            });
            
            speciesGrid.innerHTML = html;
            speciesGrid.className = `species-grid ${currentView}-view`;
        }
        
        // 过滤物种数据
        // 在 filterSpecies 函数中添加搜索过滤
        function filterSpecies() {
          let allSpecies = [];
          
          // 获取所有物种
          speciesData[currentPageType]?.forEach(order => {
            order.families.forEach(family => {
              family.genera.forEach(genus => {
                genus.species.forEach(species => {
                  // 添加分类路径信息，用于后续筛选
                  allSpecies.push({
                    ...species,
                    order: order.order,
                    family: family.family,
                    genus: genus.genus
                  });
                });
              });
            });
          });
          
          // 应用搜索过滤
          if (currentFilters.search) {
            const searchTerm = currentFilters.search.toLowerCase();
            allSpecies = allSpecies.filter(species => 
              species.name.toLowerCase().includes(searchTerm) ||
              species.scientific_name.toLowerCase().includes(searchTerm)
            );
          }
          
          // 应用分类筛选
          if (currentFilters.taxonomy) {
            const { type, id } = currentFilters.taxonomy;
            if (type === 'order') {
              allSpecies = allSpecies.filter(species => species.order === id);
            } else if (type === 'family') {
              allSpecies = allSpecies.filter(species => species.family === id);
            } else if (type === 'genus') {
              allSpecies = allSpecies.filter(species => species.genus === id);
            }
          }
          
          // 应用保护等级筛选
          if (currentFilters.conservation !== 'all') {
            allSpecies = allSpecies.filter(species => 
              species.conservation_status === currentFilters.conservation
            );
          }
          
          // 应用排序
          if (currentFilters.sort === 'name') {
            allSpecies.sort((a, b) => a.name.localeCompare(b.name));
          } else if (currentFilters.sort === 'scientific') {
            allSpecies.sort((a, b) => a.scientific_name.localeCompare(b.scientific_name));
          } else if (currentFilters.sort === 'conservation') {
            // 定义保护等级优先级
            const statusOrder = { 'CR': 1, 'EN': 2, 'VU': 3, 'NT': 4, 'LC': 5, '': 6 };
            allSpecies.sort((a, b) => {
              const aStatus = a.conservation_status || '';
              const bStatus = b.conservation_status || '';
              return statusOrder[aStatus] - statusOrder[bStatus];
            });
          }
          
          return allSpecies;
        }
        
        // 获取保护等级对应的CSS类
        function getConservationStatusClass(status) {
            const statusMap = {
                'CR': 'critical',
                'EN': 'endangered',
                'VU': 'vulnerable',
                'NT': 'near-threatened',
                'LC': 'least-concern'
            };
            
            return statusMap[status] || 'unknown';
        }
        
        // 截断文本
        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
        
        // 添加事件监听器
        function addEventListeners() {
            // 分类节点点击事件
            taxonomyTree.addEventListener('click', function(e) {
                const node = e.target.closest('.taxonomy-node');
                if (!node) return;
                
                const type = node.dataset.type;
                const id = node.dataset.id;
                
                if (type === 'species') {
                    // 显示物种详情
                    showSpeciesDetail(id);
                } else {
                    // 切换展开/折叠
                    const parentItem = node.closest('.taxonomy-item');
                    const sublist = parentItem.querySelector('.taxonomy-sublist');
                    
                    if (sublist) {
                        parentItem.classList.toggle('expanded');
                        const icon = node.querySelector('.toggle-icon i');
                        if (parentItem.classList.contains('expanded')) {
                            icon.className = 'fas fa-caret-down';
                        } else {
                            icon.className = 'fas fa-caret-right';
                        }
                    }
                    
                    // 更新筛选
                    currentFilters.taxonomy = { type, id };
                    renderSpeciesGrid();
                }
            });
            
            // 物种卡片点击事件
            speciesGrid.addEventListener('click', function(e) {
                const card = e.target.closest('.species-card');
                if (!card) return;
                
                const speciesName = card.dataset.species;
                showSpeciesDetail(speciesName);
            });
            
            // 模态框关闭
            modalClose.addEventListener('click', closeModal);
            speciesModal.addEventListener('click', function(e) {
                if (e.target === speciesModal) closeModal();
            });
            
            // 侧边栏切换
            sidebarToggle.addEventListener('click', function() {
                speciesSidebar.classList.toggle('collapsed');
                updateSidebarToggleIcon();
            });
            
            // 搜索切换
            searchToggle.addEventListener('click', function() {
                searchContainer.classList.toggle('visible');
            });
            
            // 清除搜索
            clearSearch.addEventListener('click', function() {
                speciesSearch.value = '';
                currentFilters.search = '';
                renderSpeciesGrid();
            });
            
            // 搜索输入
            speciesSearch.addEventListener('input', function() {
                currentFilters.search = this.value.toLowerCase();
                renderSpeciesGrid();
            });
            
            // 视图切换
            gridViewBtn.addEventListener('click', function() {
                setCurrentView('grid');
            });
            
            listViewBtn.addEventListener('click', function() {
                setCurrentView('list');
            });
            
            // 筛选变化
            conservationFilter.addEventListener('change', function() {
                currentFilters.conservation = this.value;
                renderSpeciesGrid();
            });
            
            sortBy.addEventListener('change', function() {
                currentFilters.sort = this.value;
                renderSpeciesGrid();
            });
        }
        
        // 显示物种详情
        function showSpeciesDetail(speciesName) {
            // 查找物种数据
            let species = null;
            
            speciesData[currentPageType]?.forEach(order => {
                order.families.forEach(family => {
                    family.genera.forEach(genus => {
                        const found = genus.species.find(s => s.name === speciesName);
                        if (found) species = found;
                    });
                });
            });
            
            if (!species) return;
            
            const statusClass = getConservationStatusClass(species.conservation_status);
            
            // 构建图片HTML - 支持多张图片，纵向排列
            let imagesHTML = '';
            if (species.images && species.images.length > 0) {
                imagesHTML = species.images.map(img => `
                    <div class="detail-image">
                        <img src="{{ '${img}' | relative_url }}" alt="${species.name}" 
                             onerror="this.src='{{ '/assets/images/placeholder.jpg' | relative_url }}'">
                    </div>
                `).join('');
            } else if (species.image) {
                // 向后兼容：如果只有单张图片
                imagesHTML = `
                    <div class="detail-image">
                        <img src="{{ '${species.image}' | relative_url }}" alt="${species.name}" 
                             onerror="this.src='{{ '/assets/images/placeholder.jpg' | relative_url }}'">
                    </div>
                `;
            } else {
                // 没有图片时使用占位图
                imagesHTML = `
                    <div class="detail-image">
                        <img src="{{ '/assets/images/placeholder.jpg' | relative_url }}" alt="${species.name}">
                    </div>
                `;
            }
            
            // 构建参考资料HTML
            let referencesHTML = '';
            if (species.references && species.references.length > 0) {
                referencesHTML = `
                    <div class="references-section">
                        <h3>参考资料</h3>
                        <ul class="references-list">
                            ${species.references.map(ref => `
                                <li><a href="${ref.url}" target="_blank" rel="noopener">${ref.name}</a></li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // 填充模态框内容
            modalBody.innerHTML = `
                <div class="species-detail">
                    <div class="detail-header">
                        <h2>${species.name}</h2>
                        <span class="scientific-name">${species.scientific_name}</span>
                        <span class="conservation-status ${statusClass}">${species.conservation_status || '未知'}</span>
                    </div>
                    
                    <div class="detail-content">
                        <div class="detail-images-container">
                            ${imagesHTML}
                        </div>
                        
                        <div class="detail-info">
                            <h3>物种描述</h3>
                            <p>${species.description || '暂无描述'}</p>
                            
                            ${species.habitat ? `<h3>栖息环境</h3><p>${species.habitat}</p>` : ''}
                            ${species.distribution ? `<h3>分布范围</h3><p>${species.distribution}</p>` : ''}
                            ${species.conservation_notes ? `<h3>保护状况</h3><p>${species.conservation_notes}</p>` : ''}
                            
                            ${referencesHTML}
                        </div>
                    </div>
                </div>
            `;
            
            // 显示模态框
            speciesModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
                
        // 关闭模态框
        function closeModal() {
            speciesModal.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // 设置当前视图
        function setCurrentView(view) {
            currentView = view;
            
            if (view === 'grid') {
                gridViewBtn.classList.add('active');
                listViewBtn.classList.remove('active');
            } else {
                gridViewBtn.classList.remove('active');
                listViewBtn.classList.add('active');
            }
            
            renderSpeciesGrid();
        }
        
        // 更新侧边栏切换按钮图标
        function updateSidebarToggleIcon() {
            if (speciesSidebar.classList.contains('collapsed')) {
                sidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
            } else {
                sidebarToggle.innerHTML = '<i class="fas fa-times"></i>';
            }
        }
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', initSpeciesPage);
        
        // 添加恢复按钮事件监听
        document.getElementById('resetFilters').addEventListener('click', function() {
          // 重置所有筛选条件
          currentFilters = {
            conservation: 'all',
            sort: 'name',
            search: '',
            taxonomy: null
          };
          
          // 重置UI元素
          conservationFilter.value = 'all';
          sortBy.value = 'name';
          speciesSearch.value = '';
          
          // 折叠所有展开的分类节点
          document.querySelectorAll('.taxonomy-item.expanded').forEach(item => {
            item.classList.remove('expanded');
            const icon = item.querySelector('.toggle-icon i');
            if (icon) icon.className = 'fas fa-caret-right';
          });
          
          // 重新渲染网格
          renderSpeciesGrid();
        });
        
        // 确保筛选变化时更新状态并重新渲染
        conservationFilter.addEventListener('change', function() {
          currentFilters.conservation = this.value;
          renderSpeciesGrid();
        });
        
        sortBy.addEventListener('change', function() {
          currentFilters.sort = this.value;
          renderSpeciesGrid();
        });
        
    </script>
</body>

</html>
